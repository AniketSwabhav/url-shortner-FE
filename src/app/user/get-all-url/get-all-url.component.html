<div class="container py-5">
  <!-- Flash Message -->
  <div
    *ngIf="flash.message"
    class="alert alert-{{ flash.type }} alert-dismissible fade show"
    role="alert"
  >
    {{ flash.message }}
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="flash.message = ''"
    ></button>
  </div>

  <button *ngIf="isAdminMode" class="btn btn-secondary mb-3" (click)="goBack()">
    ‚Üê Back to Dashboard
  </button>

  <div class="card shadow-lg border-0">
    <div class="card-header bg-white border-bottom">
      <h3 class="mb-0 text-primary">All Shortened URLs</h3>
    </div>

    <div class="card-body bg-light">
      <!-- Search -->
      <div class="row mb-4">
        <div class="col-md-8">
          <div class="input-group">
            <input
              type="text"
              class="form-control"
              placeholder="Search by Short URL or Long URL..."
              [(ngModel)]="searchTerm"
              (keydown.enter)="searchUrls()"
            />
            <button class="btn btn-primary" (click)="searchUrls()">
              Search
            </button>
            <button class="btn btn-outline-secondary" (click)="clearSearch()">
              Clear
            </button>
          </div>
        </div>
      </div>

      <!-- URLs Table -->
      <div *ngIf="urls.length > 0" class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th scope="col">#</th>
              <th scope="col">üîó Short URL</th>
              <th scope="col">Long URL</th>
              <th scope="col">Visits Remaining</th>
              <th scope="col">Total Visits</th>
              <th scope="col" *ngIf="!isAdminMode">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let url of urls; let i = index">
              <td>{{ i + 1 + offset }}</td>

              <!-- Short URL -->
              <td class="text-center">
                <a
                  [href]="'http://localhost:4200/redirect/' + url.shortUrl"
                  target="_blank"
                  class="fw-bold text-decoration-none text-primary"
                >
                  {{ url.shortUrl }}
                </a>
                <br />
              </td>

              <!-- Long URL -->
              <td
                class="text-truncate"
                style="max-width: 300px"
                [title]="url.longUrl"
              >
                {{ url.longUrl }}
              </td>

              <!-- Visits Remaining -->
              <td class="text-center">
                <span class="badge rounded-pill bg-warning text-dark px-3 py-2">
                  {{ url.remainingVisits }}
                </span>
              </td>

              <!-- Total Visits -->
              <td class="text-center">
                <span class="badge rounded-pill bg-success px-3 py-2">
                  {{ url.visitCount }}
                </span>
              </td>

              <!-- Actions -->
              <td *ngIf="!isAdminMode" class="text-center">
                <div class="btn-group btn-group-sm" role="group">
                  <button
                    class="btn btn-outline-primary"
                    (click)="copyShortUrl(url.shortUrl)"
                    title="Copy Short URL"
                  >
                    üìã Copy
                  </button>
                  <button
                    class="btn btn-outline-warning"
                    (click)="openEditModal(url)"
                    title="Edit URL"
                  >
                    ‚úèÔ∏è Edit
                  </button>
                  <button
                    *ngIf="!isAdminMode"
                    class="btn btn-sm btn-outline-primary"
                    (click)="renewUrlVisit(url.id)"
                  >
                    üîÅ Renew Visit
                  </button>
                  <button
                    class="btn btn-outline-danger"
                    (click)="deleteUrl(url.id)"
                    title="Delete URL"
                  >
                    üóëÔ∏è Delete
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Pagination -->
        <app-pagination
          [items]="urls"
          [totalItems]="totalUrlRecords"
          [limit]="limit"
          [offset]="offset"
          (pageChange)="changePage($event)"
        ></app-pagination>
      </div>

      <!-- No URLs Message -->
      <div *ngIf="urls.length === 0" class="text-center py-4 text-muted">
        <i class="bi bi-link-45deg" style="font-size: 3rem"></i>
        <h4 class="mt-3">No URLs Found</h4>
        <p>No shortened URLs have been created yet.</p>
      </div>
    </div>
  </div>
</div>

<!-- Edit URL Modal -->
<div
  *ngIf="showEditModal"
  class="modal show d-block"
  tabindex="-1"
  style="background-color: rgba(0, 0, 0, 0.5)"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit URL</h5>
        <button
          type="button"
          class="btn-close"
          (click)="closeEditModal()"
        ></button>
      </div>
      <div class="modal-body">
        <form #editForm="ngForm">
          <div class="mb-3">
            <label class="form-label">Long URL *</label>
            <input
              type="url"
              class="form-control"
              [(ngModel)]="editData.longUrl"
              name="longUrl"
              required
              placeholder="https://example.com"
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Short URL *</label>
            <div class="input-group">
              <input
                type="text"
                class="form-control"
                [(ngModel)]="editData.shortUrl"
                name="shortUrl"
                required
                placeholder="Enter 2-5 character alias"
                minlength="2"
                maxlength="5"
              />
              <button
                type="button"
                class="btn btn-outline-secondary"
                (click)="generateShortUrl()"
                title="Generate random short URL"
              >
                üîÑ Generate
              </button>
            </div>
            <small class="text-muted"
              >2-5 characters, letters and numbers only</small
            >
          </div>
          <div class="alert alert-info" *ngIf="editData.shortUrl">
            <small>
              <strong>Preview:</strong><br />
              http://localhost:4200/redirect/{{ editData.shortUrl }}
            </small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" (click)="closeEditModal()">
          Cancel
        </button>
        <button
          class="btn btn-primary"
          (click)="updateUrl()"
          [disabled]="isUpdating || !editData.longUrl || !editData.shortUrl"
        >
          <span
            *ngIf="isUpdating"
            class="spinner-border spinner-border-sm me-2"
          ></span>
          {{ isUpdating ? "Updating..." : "Update URL" }}
        </button>
      </div>
    </div>
  </div>
</div>
